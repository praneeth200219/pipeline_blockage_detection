#ORG 0000H
JMP MAIN
#ORG 003CH
JMP ISR_75
MAIN: LXI SP,0000H
LXI H,8000H
MVI A,00H
MOV M,A
INX H
MOV M,A
;DISPLAY CHECKING RAM
CALL LCD_INIT
MVI B, 80H
CALL LCD_COMMAND
MVI B,43H
CALL LCD_SENDDATA
MVI B,48H
CALL LCD_SENDDATA
MVI B,45H
CALL LCD_SENDDATA
MVI B,43H
CALL LCD_SENDDATA
MVI B,4BH
CALL LCD_SENDDATA
MVI B,49H
CALL LCD_SENDDATA
MVI B,4EH
CALL LCD_SENDDATA
MVI B,47H
CALL LCD_SENDDATA
MVI B,20H
CALL LCD_SENDDATA
MVI B,52H
CALL LCD_SENDDATA
MVI B,41H
CALL LCD_SENDDATA
MVI B,4DH
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA

LXI H,8000H
MVI A,80H
OUT 03H
MVI A,02H
OUT 00H

LOOOP: MOV A,L
ORA H
JZ CNT
MVI A,0AAH
MOV M,A
INX H
JMP LOOOP
CNT: LXI H,8000H
LOOOP1: MOV A,L 
ORA H
JZ CNT1
MOV A,M
INX H
CPI 0AAH
JNZ CNT2
JMP LOOOP1
CNT2: HLT
CNT1: MVI A,00H
OUT 00H
LXI B,0FFFFH
D1: DCX B
MOV A,C
ORA B
JNZ D1
LXI H,8000H
MVI A,00H
MOV M,A
INX H
MOV M,A
CALL LED_INIT
CALL LCD_INIT

;DISPLAY CONNECTING TO WIFI
CALL LCD_INIT
MVI B,80H
CALL LCD_COMMAND
MVI B,43H
CALL LCD_SENDDATA
MVI B,4FH
CALL LCD_SENDDATA
MVI B,4EH
CALL LCD_SENDDATA
MVI B,4EH
CALL LCD_SENDDATA
MVI B,45H
CALL LCD_SENDDATA
MVI B,43H
CALL LCD_SENDDATA
MVI B,54H
CALL LCD_SENDDATA
MVI B,49H
CALL LCD_SENDDATA
MVI B,4EH
CALL LCD_SENDDATA
MVI B,47H
CALL LCD_SENDDATA
MVI B,C0H
CALL LCD_COMMAND
MVI B,54H
CALL LCD_SENDDATA
MVI B,4FH
CALL LCD_SENDDATA
MVI B,20H
CALL LCD_SENDDATA
MVI B,57H
CALL LCD_SENDDATA
MVI B,49H
CALL LCD_SENDDATA
MVI B,46H
CALL LCD_SENDDATA
MVI B,49H
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA
MVI B,2EH
CALL LCD_SENDDATA

COIL: RIM //
 RAL
 JC COIL
 MVI B,12H

COIL2: DCR B
 JNZ COIL2
 RIM
 RAL
 JC COIL
 MVI D,00H
 MVI C,08H

COIL1: MVI B,24H

COIL3: DCR B
 JNZ COIL3
 MOV A,D
 RRC
 MOV D,A
 RIM
 ANI 80H
 ORA D
 MOV D,A
 DCR C
 JNZ COIL1
 MVI B,37H

COIL4: DCR B
 JNZ COIL4
 MOV A,D
ANI 7FH
CPI 52H
JZ COIL5
JMP COIL
COIL5: CALL WIFI_CONNECTED

CALL INTRO

PROGVERS:MVI A ,80H
OUT 03H
MVI A ,04H
OUT 00H
LXI H,8005H
MVI M,00H
INX H
MVI M,00H
INX H
MVI M,02H
MVI A,0BH
SIM
EI
CALL DELAY1SEC
DI
CALL MULTIPLY
CALL BIN2BCD
LXI H,A000
LXI D,B000
CALL BCD2ASCII
INX H
INX D
CALL BCD2ASCII
INX H
INX D
CALL BCD2ASCII

CALL LCD_INIT
 MVI B,80
 CALL LCD_COMMAND
 LXI H ,B000

MOV B,M
 CALL LCD_SENDDATA

INX H
 MOV B,M

CALL LCD_SENDDATA
MVI B,2E
CALL LCD_SENDDATA

INX H
 MOV B,M

CALL LCD_SENDDATA
MVI B, 4CH
CALL LCD_SENDDATA
MVI B,2F
CALL LCD_SENDDATA
MVI B,4DH
CALL LCD_SENDDATA
MVI B,49H
CALL LCD_SENDDATA
MVI B,4EH
CALL LCD_SENDDATA
MVI B,C0H
CALL LCD_COMMAND
LXI H,9000
MOV A,M
CPI 05
JC BLOCKAGE
MVI B,4EH
CALL LCD_SENDDATA
MVI B,4FH
CALL LCD_SENDDATA
MVI B,52H
CALL LCD_SENDDATA
MVI B,4DH
CALL LCD_SENDDATA
MVI B,41H
CALL LCD_SENDDATA
MVI B,4CH
CALL LCD_SENDDATA
MVI B,20H
CALL LCD_SENDDATA
MVI B,46H
CALL LCD_SENDDATA
MVI B,4CH
CALL LCD_SENDDATA
MVI B,4FH
CALL LCD_SENDDATA
MVI B,57H
CALL LCD_SENDDATA
JMP D2
BLOCKAGE:MVI B,42H
CALL LCD_SENDDATA
MVI B,4CH
CALL LCD_SENDDATA
MVI B,4FH
CALL LCD_SENDDATA
MVI B,43H
CALL LCD_SENDDATA
MVI B,4BH
CALL LCD_SENDDATA
MVI B,45H
CALL LCD_SENDDATA
MVI B,44H
CALL LCD_SENDDATA

D2:
LEVEL: LXI H,9000
MOV B,M
MVI C,0BH
XRA A
MAIN2:MVI A,80H
RAR
SIM
MVI D,22H
D1:DCR D
JNZ D1
STC
MOV A,B
RAR
MOV B,A
DCR C

JNZ MAIN2
 JMP PROGVERS

ISR_75: PUSH H
LXI H ,8005
INR M
POP H
EI
RET

PORTA: PUSH PSW
 PUSH H
 LXI H,8000
 MOV A,M
 OUT 00
 LXI H,8001
 MOV A,M
 OUT 03
 POP H
 POP PSW
 RET
 
LCD_BUSY: PUSH PSW
 MVI A,82
 OUT 03
 CALL PORTA
 MVI A,01
 OUT 03
 MVI A,02
 OUT 03
 MVI A,05
 OUT 03
 
LOOP_LCD: IN 01
 RAL
 JNC CONTINUE
 MVI A,00
 OUT 03
 MVI A,01
 OUT 03
 JMP LOOP_LCD
 
CONTINUE: MVI A,80
 OUT 03
 CALL PORTA
 POP PSW
 RET
 
LCD_INIT: PUSH PSW
 MVI A,80
 OUT 03
 CALL PORTA
 MVI A,38
 OUT 01
 MVI A,02
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 MVI A,00
 OUT 03
 CALL LCD_BUSY
 MVI A,0F
 OUT 01
 MVI A,02
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 MVI A,00
 OUT 03
 CALL LCD_BUSY
 MVI A,01
 OUT 01
 MVI A,02
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 MVI A,00
 OUT 03
 CALL LCD_BUSY
 MVI A,06
 OUT 01
 MVI A,02
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 CALL LCD_BUSY
 POP PSW
 RET
 
LCD_SENDDATA: PUSH PSW
 MVI A,80
 OUT 03
 CALL PORTA
 MOV A,B
 OUT 01
 MVI A,03
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 MVI A,00
 OUT 03
 CALL LCD_BUSY
 POP PSW
 RET
 
LCD_COMMAND: PUSH PSW
 MVI A,80
 OUT 03
 CALL PORTA
 MOV A,B
 OUT 01
 MVI A,02
 OUT 03
 MVI A,04
 OUT 03
 MVI A,01
 OUT 03
 MVI A,00
 OUT 03
 CALL LCD_BUSY
 POP PSW
 RET
 
MULTIPLY: PUSH H
PUSH PSW
PUSH B
PUSH D
 LHLD 8005
 XCHG
 LDA 8007
 LXI H,0000
 MVI C,08
 
LOOP: DAD H
 RAL
 JNC AHEAD
 DAD D

AHEAD: DCR C
 JNZ LOOP
 SHLD 9000

POP D
POP B
POP PSW
POP H
RET
BIN2BCD: PUSH H
PUSH PSW
LXI H,9000
MOV A,M
CALL PWRTEN
POP PSW
POP H
RET

PWRTEN:

LXI H, A000
MVI B,64H

CALL BINBCD
MVI B, 0AH
CALL BINBCD
MOV M,A
RET

BINBCD:
MVI M,FFH
NXTBUF: INR M;
SUB B;
JNC NXTBUF
ADD B
INX H;
RET

BCD2ASCII:
PUSH PSW
MOV A,M
ADI 30H
STAX D
POP PSW
RET

DELAY1SEC:
PUSH B
PUSH D
LXI B, 570H
LOOP2: MVI D, FFH
LOOP1: DCR D
JNZ LOOP1
DCX B
MOV A,C
ORA B
JNZ LOOP2
POP D
POP B
RET

LED_INIT: PUSH PSW
PUSH H
MVI A,80H
OUT 03H
MVI A,08H
OUT 00H
LXI H,8000H
MOV M,A
POP H
POP PSW
RET

WIFI_CONNECTED: PUSH PSW
PUSH H
MVI A,80H
OUT 03H
LXI H,8000H
MOV A,M
ANI 0F7H
OUT 00H
MOV M,A
MVI A,07H
LXI H,8001H
MOV M,A
OUT 03H
POP H
POP PSW
RET

INTRO:
  PUSH B
 CALL LCD_INIT
  MVI B,80H
  CALL LCD_COMMAND
  MVI B,50H
  CALL LCD_SENDDATA
  MVI B,49H
  CALL LCD_SENDDATA
  MVI B,50H
  CALL LCD_SENDDATA
  MVI B,45H
  CALL LCD_SENDDATA
  MVI B,20H
  CALL LCD_SENDDATA
  MVI B,42H
  CALL LCD_SENDDATA
  MVI B,4CH
  CALL LCD_SENDDATA
  MVI B,4FH
  CALL LCD_SENDDATA
  MVI B,43H
  CALL LCD_SENDDATA
  MVI B,4BH
  CALL LCD_SENDDATA
  MVI B,41H
  CALL LCD_SENDDATA
  MVI B,47H
  CALL LCD_SENDDATA
  MVI B,45H
  CALL LCD_SENDDATA
  MVI B,0C0H
  CALL LCD_COMMAND
  MVI B,44H
  CALL LCD_SENDDATA
  MVI B,45H
  CALL LCD_SENDDATA
  MVI B,54H
  CALL LCD_SENDDATA
  MVI B,45H
  CALL LCD_SENDDATA
  MVI B,43H
  CALL LCD_SENDDATA
  MVI B,54H
  CALL LCD_SENDDATA
  MVI B,49H
  CALL LCD_SENDDATA
  MVI B,4FH
  CALL LCD_SENDDATA
  MVI B,4EH
  CALL LCD_SENDDATA
  POP B
  RET
